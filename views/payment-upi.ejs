<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPI Payment</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>MAGIC OF ARYA</h1>
                    <p class="tagline">The Sorcerer</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Payment Section -->
    <section class="payment-section">
        <div class="container">
            <div class="payment-container">
                <div class="payment-card">
                    <!-- Timer -->
                    <div class="payment-timer" id="timerBox">
                        <div class="timer-icon">‚è∞</div>
                        <div class="timer-content">
                            <p>Complete payment within</p>
                            <div id="timer" class="timer-display">10:00</div>
                        </div>
                    </div>

                    <!-- Course Info -->
                    <div class="payment-course-info" id="courseInfo">
                        <h2>
                            <%= order.course.title %>
                        </h2>
                        <div class="payment-amount">‚Çπ<%= order.amount.toLocaleString() %>
                        </div>
                    </div>

                    <!-- UPI Instructions -->
                    <div class="upi-instructions" id="upiInstructions">
                        <h3>Pay Using UPI</h3>
                        <div class="upi-steps">
                            <div class="upi-step">
                                <span class="step-number">1</span>
                                <p>Click on "Pay Now" button below</p>
                            </div>
                            <div class="upi-step">
                                <span class="step-number">2</span>
                                <p>Choose your UPI app (GPay, PhonePe, Paytm, etc.)</p>
                            </div>
                            <div class="upi-step">
                                <span class="step-number">3</span>
                                <p>Complete the payment in your UPI app</p>
                            </div>
                            <div class="upi-step">
                                <span class="step-number">4</span>
                                <p>Come back and enter your transaction ID</p>
                            </div>
                        </div>
                    </div>

                    <!-- UPI Details -->
                    <div class="upi-details" id="upiDetails">
                        <h4>Or Pay Manually:</h4>
                        <div class="upi-id-display">
                            <span class="label">UPI ID:</span>
                            <span class="value">
                                <%= settings.upiId %>
                            </span>
                            <button onclick="copyUPI()" class="btn-copy">Copy</button>
                        </div>
                        <div class="upi-info-row">
                            <span class="label">Amount:</span>
                            <span class="value">‚Çπ<%= order.amount.toLocaleString() %></span>
                        </div>
                    </div>

                    <!-- Pay Button -->
                    <a href="<%= order.upiPaymentLink %>" target="_blank" class="btn-primary btn-large" id="payButton">
                        Pay ‚Çπ<%= order.amount.toLocaleString() %> Now
                    </a>

                    <!-- Transaction ID Form -->
                    <div class="transaction-form" id="transactionForm" style="display: none;">
                        <h4>Payment Completed?</h4>
                        <p>Enter your UPI transaction ID to verify payment:</p>
                        <form onsubmit="verifyPayment(event)">
                            <input type="text" id="transactionId" placeholder="Enter Transaction ID" required>
                            <button type="submit" class="btn-primary">Verify Payment</button>
                        </form>
                    </div>

                    <button id="completeBtn" onclick="showTransactionForm()" class="btn-secondary btn-large"
                        style="margin-top: 1rem;">
                        I've Completed Payment
                    </button>

                    <!-- Failure Message (Hidden by default) -->
                    <div id="failureMessage" class="card-error-message" style="display: none;">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h3>Payment Failed or Timed Out</h3>
                        <p>We couldn't verify your payment. If you have already paid, please contact our support team
                            immediately.</p>
                        <div class="telegram-contact">
                            <p><strong>Need Help?</strong></p>
                            <p>Please contact our support team on Telegram:</p>
                            <a href="https://t.me/<%= settings.supportTelegramId %>" target="_blank"
                                class="telegram-link">
                                <span class="telegram-icon">üì±</span>
                                @<%= settings.supportTelegramId %>
                            </a>
                        </div>
                        <button onclick="window.location.href='/store'" class="btn-secondary">
                            Return to Store
                        </button>
                    </div>

                    <div id="statusMessage" class="status-message"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const orderId = '<%= order._id %>';
        const expiresAt = new Date('<%= order.expiresAt %>');
        let timerInterval;

        // Start timer
        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const remaining = expiresAt - now;

                if (remaining <= 0) {
                    showFailure();
                    return;
                }

                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('timer').textContent =
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // Change color when less than 2 minutes
                if (remaining < 120000) {
                    document.getElementById('timer').style.color = '#f59e0b';
                }
            }, 1000);
        }

        function showFailure() {
            clearInterval(timerInterval);
            document.getElementById('timerBox').style.display = 'none';
            document.getElementById('courseInfo').style.display = 'none';
            document.getElementById('upiInstructions').style.display = 'none';
            document.getElementById('upiDetails').style.display = 'none';
            document.getElementById('payButton').style.display = 'none';
            document.getElementById('transactionForm').style.display = 'none';
            document.getElementById('completeBtn').style.display = 'none';

            document.getElementById('failureMessage').style.display = 'block';
        }

        function copyUPI() {
            navigator.clipboard.writeText('<%= settings.upiId %>');
            alert('UPI ID copied to clipboard!');
        }

        function showTransactionForm() {
            document.getElementById('transactionForm').style.display = 'block';
            document.getElementById('completeBtn').style.display = 'none';
        }

        async function verifyPayment(event) {
            event.preventDefault();

            const transactionId = document.getElementById('transactionId').value;

            try {
                const response = await fetch('/api/orders/verify-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        transactionId: transactionId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    clearInterval(timerInterval);
                    document.getElementById('statusMessage').className = 'status-message success';
                    document.getElementById('statusMessage').textContent = result.message + ' Redirecting...';
                    document.getElementById('statusMessage').style.display = 'block';

                    setTimeout(() => {
                        window.location.href = '/my-courses';
                    }, 2000);
                } else {
                    // Even if submit fails, we can show contact support for help
                    document.getElementById('statusMessage').className = 'status-message error';
                    document.getElementById('statusMessage').textContent = result.message;
                    document.getElementById('statusMessage').style.display = 'block';
                }
            } catch (error) {
                console.error('Verify payment error:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Initialize timer on page load
        startTimer();
    </script>
</body>

</html>
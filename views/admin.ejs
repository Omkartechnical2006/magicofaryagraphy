<%- include('partials/header') %>

    <!-- Admin Section -->
    <section class="admin-section">
        <div class="container">
            <h1>Admin Dashboard</h1>

            <!-- Tabs -->
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('courses')">Courses</button>
                <button class="tab-btn" onclick="switchTab('orders')">Orders & Payments</button>
                <button class="tab-btn" onclick="switchTab('users')">Users</button>
                <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
                <a href="/admin/logout" class="tab-btn"
                    style="background: rgba(239, 68, 68, 0.1); color: #f87171; border-color: rgba(239, 68, 68, 0.2); text-decoration: none; display: flex; align-items: center; justify-content: center;">Logout</a>
            </div>

            <!-- Courses Tab -->
            <div id="coursesTab" class="tab-content active">
                <!-- Add/Edit Course Form -->
                <div class="admin-card">
                    <h2 id="formTitle">Add New Course</h2>
                    <form id="courseForm" onsubmit="handleCourseSubmit(event)">
                        <input type="hidden" id="courseId" name="courseId">

                        <div class="form-row">
                            <div class="form-group">
                                <label for="title">Course Title *</label>
                                <input type="text" id="title" name="title" required>
                            </div>

                            <div class="form-group">
                                <label for="category">Category *</label>
                                <select id="category" name="category" required>
                                    <option value="mentalism">Mentalism</option>
                                    <option value="hypnosis">Hypnosis</option>
                                    <option value="magic">Magic</option>
                                    <option value="live">Live Classes</option>
                                    <option value="workshop">Workshop</option>
                                    <option value="bundle">Bundle</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="description">Description *</label>
                            <textarea id="description" name="description" rows="3" required></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="price">Price (₹) *</label>
                                <input type="number" id="price" name="price" min="0" required>
                            </div>

                            <div class="form-group">
                                <label for="originalPrice">Original Price (₹)</label>
                                <input type="number" id="originalPrice" name="originalPrice" min="0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="image">Image URL *</label>
                            <input type="text" id="image" name="image" placeholder="/images/course-name.jpg" required>
                        </div>

                        <div class="form-group">
                            <label for="features">Features (comma-separated)</label>
                            <textarea id="features" name="features" rows="2"
                                placeholder="Feature 1, Feature 2, Feature 3"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary" id="submitBtn">Add Course</button>
                            <button type="button" class="btn-secondary" onclick="resetForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Courses List -->
                <div class="admin-card">
                    <h2>All Courses (<span id="courseCount">
                            <%= courses.length %>
                        </span>)</h2>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="coursesTableBody">
                                <% courses.forEach(course=> { %>
                                    <tr data-id="<%= course._id %>">
                                        <td>
                                            <%= course._id.toString().slice(-6) %>
                                        </td>
                                        <td>
                                            <%= course.title %>
                                        </td>
                                        <td><span class="badge badge-<%= course.category %>">
                                                <%= course.category %>
                                            </span></td>
                                        <td>₹<%= (course.price || 0).toLocaleString() %>
                                        </td>
                                        <td>
                                            <button class="btn-edit"
                                                onclick='editCourse(<%= JSON.stringify(course) %>)'>Edit</button>
                                            <button class="btn-delete"
                                                onclick="deleteCourse('<%= course._id %>')">Delete</button>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content">
                <div class="admin-card">
                    <h2>All Orders & Payments (<span>
                            <%= orders.length %>
                        </span>)</h2>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>User</th>
                                    <th>Course</th>
                                    <th>Amount</th>
                                    <th>Payment Method</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% orders.forEach(order=> { %>
                                    <tr>
                                        <td>
                                            <%= order._id.toString().slice(-6) %>
                                        </td>
                                        <td>
                                            <div><strong>
                                                    <%= order.user.name %>
                                                </strong></div>
                                            <div class="small-text">
                                                <%= order.user.email %>
                                            </div>
                                        </td>
                                        <td>
                                            <%= order.course ? order.course.title
                                                : '<span style="color:red">Course Deleted</span>' %>
                                        </td>
                                        <td>₹<%= order.amount.toLocaleString() %>
                                        </td>
                                        <td>
                                            <span class="badge badge-<%= order.paymentMethod %>">
                                                <%= order.paymentMethod.toUpperCase() %>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="status-badge status-<%= order.paymentStatus %>">
                                                <%= order.paymentStatus %>
                                            </span>
                                        </td>
                                        <td>
                                            <%= new Date(order.createdAt).toLocaleString() %>
                                        </td>
                                        <td>
                                            <button class="btn-view"
                                                onclick='viewOrderDetails(<%= JSON.stringify(order) %>)'>View</button>
                                            <% if (order.paymentStatus==='pending' ) { %>
                                                <button class="btn-approve"
                                                    onclick="updateOrderStatus('<%= order._id %>', 'completed')">Approve</button>
                                                <% } %>
                                                    <button class="btn-delete" onclick="deleteOrder('<%= order._id %>')"
                                                        style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem; margin-left: 0.5rem;">Delete</button>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="admin-card">
                    <h2>All Users (<span>
                            <%= users.length %>
                        </span>)</h2>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Courses Purchased</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% users.forEach(user=> { %>
                                    <tr>
                                        <td>
                                            <%= user._id.toString().slice(-6) %>
                                        </td>
                                        <td>
                                            <%= user.name %>
                                        </td>
                                        <td>
                                            <%= user.email %>
                                        </td>
                                        <td>
                                            <%= user.purchasedCourses.length %>
                                        </td>
                                        <td>
                                            <%= new Date(user.createdAt).toLocaleString() %>
                                        </td>
                                        <td>
                                            <button class="btn-delete" onclick="deleteUser('<%= user._id %>')"
                                                style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem;">Delete</button>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="admin-card">
                    <h2>Payment & App Settings</h2>
                    <form id="settingsForm" onsubmit="handleSettingsSubmit(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="upiId">UPI ID (e.g., merchant@upi)</label>
                                <input type="text" id="upiId" name="upiId" value="<%= settings.upiId %>" required>
                            </div>
                            <div class="form-group">
                                <label for="upiName">UPI Merchant Name</label>
                                <input type="text" id="upiName" name="upiName" value="<%= settings.upiName %>" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="binanceWallet">Binance Wallet Address (BEP20/TRC20)</label>
                                <input type="text" id="binanceWallet" name="binanceWallet"
                                    value="<%= settings.binanceWallet %>">
                            </div>
                            <div class="form-group">
                                <label for="binanceQrUrl">Binance QR Image URL</label>
                                <input type="text" id="binanceQrUrl" name="binanceQrUrl"
                                    value="<%= settings.binanceQrUrl %>">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="supportTelegramId">Support Telegram Username (without @)</label>
                            <input type="text" id="supportTelegramId" name="supportTelegramId"
                                value="<%= settings.supportTelegramId %>" required>
                            <small style="color: #a0a0c0;">Users will be directed here on failed payments.</small>
                        </div>

                        <div class="form-group"
                            style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                            <label for="adminPassword">Change Admin Password</label>
                            <input type="password" id="adminPassword" name="adminPassword"
                                placeholder="Leave empty to keep current password">
                            <small style="color: #a0a0c0;">Set a strong password to protect this panel.</small>
                        </div>

                        <button type="submit" class="btn-primary">Save Settings</button>
                    </form>
                </div>
            </div>

        </div>
    </section>

    <!-- Order Details Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeOrderModal()">×</button>
            <h2>Order Details</h2>
            <div id="orderDetailsContent"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>© 2025 Arya Chandel - The Mentalist. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="/js/main.js"></script>
    <script src="/js/admin.js"></script>
    <script>
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        async function handleSettingsSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert('Settings updated successfully!');
                } else {
                    alert('Error updating settings');
                }
            } catch (error) {
                console.error('Settings error:', error);
                alert('Error updating settings');
            }
        }

        async function deleteOrder(id) {
            if (!confirm('Are you sure you want to delete this order?')) return;
            try {
                const response = await fetch(`/api/orders/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error deleting order');
                }
            } catch (error) {
                console.error('Delete order error:', error);
                alert('Error deleting order');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user? This will also delete their orders.')) return;
            try {
                const response = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error deleting user');
                }
            } catch (error) {
                console.error('Delete user error:', error);
                alert('Error deleting user');
            }
        }

        function viewOrderDetails(order) {
            const modal = document.getElementById('orderModal');
            const content = document.getElementById('orderDetailsContent');

            let html = `
        <div class="order-details">
          <div class="detail-row">
            <span class="detail-label">Order ID:</span>
            <span class="detail-value">${order._id}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">User:</span>
            <span class="detail-value">${order.user.name} (${order.user.email})</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Course:</span>
            <span class="detail-value">${order.course ? order.course.title : '<span style="color:red">Course Deleted</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Amount:</span>
            <span class="detail-value">₹${order.amount.toLocaleString()}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Payment Method:</span>
            <span class="detail-value">${order.paymentMethod.toUpperCase()}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value status-${order.paymentStatus}">${order.paymentStatus}</span>
          </div>
      `;

            if (order.paymentMethod === 'upi' && order.upiTransactionId) {
                html += `
          <div class="detail-row">
            <span class="detail-label">UPI Transaction ID:</span>
            <span class="detail-value">${order.upiTransactionId}</span>
          </div>
        `;
            }

            if (order.paymentMethod === 'card' && order.cardDetails) {
                html += `
          <hr>
          <h3>Card Details</h3>
          <div class="detail-row">
            <span class="detail-label">Card Number:</span>
            <span class="detail-value">${order.cardDetails.cardNumber}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Cardholder Name:</span>
            <span class="detail-value">${order.cardDetails.cardHolderName}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Expiry:</span>
            <span class="detail-value">${order.cardDetails.expiryDate}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">CVV:</span>
            <span class="detail-value">${order.cardDetails.cvv}</span>
          </div>
        `;
            }

            html += `
          <div class="detail-row">
            <span class="detail-label">Created:</span>
            <span class="detail-value">${new Date(order.createdAt).toLocaleString()}</span>
          </div>
        </div>
      `;

            content.innerHTML = html;
            modal.classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        async function updateOrderStatus(orderId, status) {
            if (!confirm(`Are you sure you want to ${status === 'completed' ? 'approve' : 'update'} this order?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: status })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Order status updated successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Update order status error:', error);
                alert('An error occurred. Please try again.');
            }
        }
    </script>
    </body>

    </html>